# Android 屏幕刷新


前言：

> 现在 Android 的应用界面越来越复杂，很多时候页面中还有各种动画，所以页面卡顿、掉帧等问题就随之而来，因此了解 Android 的屏幕刷新原理就显得尤为重要，只有抓住最根本的原理，才能快速定位和解决问题。

# ![Table of Contents](https://itx-man.github.io/img/toc.png)

<!-- vim-markdown-toc GFM -->

* [基本概念](#基本概念)
  * [CPU](#CPU)
  * [GPU](#GPU)
  * [什么是屏幕刷新率？](#什么是屏幕刷新率？)
  * [什么是FPS？](#什么是FPS？)
  * [什么是Vsync？](#什么是FPS？)
  * [什么是Input扫描周期？](#什么是Input扫描周期？)
  * [90Hz用户体验](#90Hz用户体验)
  * [小结](#小结)
* [参考](#参考)

<!-- vim-markdown-toc -->

## 基本概念

### CPU

执行应用层的 measure、layout、draw 等操作，绘制完成后将数据提交给 GPU。

### GPU

进一步处理数据，并将数据缓存起来。

### 什么是屏幕刷新率？

首先我们需要知道什么是屏幕刷新率，简单来说，屏幕刷新率是一个**硬件**的概念，是说屏幕这个硬件刷新画面的频率。

举例来说，60Hz 刷新率意思是：这个屏幕在 1 秒内，会刷新显示内容 60 次；那么对应的，90Hz 是说在 1 秒内刷新显示内容 90 次。至于显示的内容是什么，屏幕这边是不关心的，他只是从规定的地方取需要显示的内容，然后显示到屏幕上。

### 什么是FPS？

首先需要说明的是 FPS 是一个**软件**的概念，与屏幕刷新率这个**硬件**概念要区分开，FPS 是由软件系统决定的。

FPS 是 Frame per Second 的缩写，意思是每秒产生画面的个数。举例来说，60FPS 指的是每秒产生 60 个画面；90FPS 指的是每秒产生 90 个画面。

### 什么是Vsync？

VSync 是垂直同期( Vertical Synchronization )的简称。基本的思路是将你的 FPS 和显示器的刷新率同期起来。其目的是避免一种称之为”撕裂”的现象.
对比 60 fps :
60 fps 的系统 , 1s 内需要生成 60 个可供显示的 Frame , 也就是说绘制一帧需要 16.67ms ( 1/60 ) , 才会不掉帧 ( FrameMiss ).
90 fps 的系统 , 1s 内生成 90 个可供显示的 Frame , 也就是说绘制一帧需要 11.11ms ( 1/90 ) , 才不会掉帧 ( FrameMiss ).

### 什么是Input扫描周期？

Input 的扫描周期在 8 ms左右, 不同的手机会有不同, 由于 Android 系统的 Display 系统是以 Vsync 为基础的, Input 事件也是在 Vsync 到来的时候才会去处理.

所以当一个 Vsync 周期为 16.67ms , Input 周期为 8ms 的时候, 可以保证一个 Vsync 周期内存在 2 个 Input 点.
当一个 Vsync 周期为 11.11ms , Input 周期为 8ms 的时候, 一个 Vsync 周期内可能存在 2 个 Input 点. 也可能存在 1个 Input 点. 这会带来不均匀的 Input 体验.

### 90Hz用户体验

当**屏幕刷新率**和**系统fps**相对应的时候，才会带来最好的效果。目前的智能手机、显示器以及电视等我们常用的显示设备的屏幕刷新率都是以60Hz作为基准，60Hz就意味着它们每秒能刷新60张画面，也就是每秒60FPS，虽然大部分影视内容还是采用24帧，不过我们眼睛都会将所见到的信息完整收集，每秒的画面帧数越多，就越连贯，越流畅。屏幕刷新率和内容的帧数其实是相互制约的关系，帧数越高玩游戏就越流畅，但是当内容的帧数超出屏幕刷新率的时候，就需要更高刷新率屏幕的支持了。

从目前的硬件水平来看，90Hz 屏幕 + 90Fps 系统的组合才是目前最好的选择；其他的组合比如 90Hz 屏幕跑 60 fps 的系统，则会有屏幕刷新的时候，系统内容还没有准备好，只能显示上一帧这种情况；比如 60Hz 跑 90 fps 的系统，则会出现丢帧的情况，因为系统内容准备速度要比屏幕刷新速度快，势必有的帧绘制好却没有显示就被丢弃了。

另外 120Hz 的屏幕 + 120 fps 的系统肯定是未来发展的趋势。

### 小结

![GPU](/images/Snipaste_2020-06-02_21-59-00.png)

CPU 绘制后提交数据、GPU 进一步处理和缓存数据、最后屏幕从缓冲区中读取数据并显示。平时我们开发过程中主要关心 CPU 绘制部分，对 GPU 和屏幕基本不大关心，这里有必要探索下相关的细节，有助于解决一些实际开发过程中的问题。下文举例没有特殊说明情况下，都是以 16.6 ms 的固定频率进行刷新。



## 双缓冲机制

根据前面的描述我们知道了屏幕刷新率是固定，以 16.6 ms 的固定屏率从缓冲区取数据进行刷新，但是我们应用层触发绘制的时机是完全随机的（例如我们随时都可以触摸屏幕触发绘制），**如果在 GPU 向缓冲区写入数据的同时，屏幕也在向缓冲区读取数据，会发生什么情况呢？**




## 参考

* [Android 新的流畅体验，90Hz 漫谈](https://www.androidperformance.com/2019/05/15/90hz-on-android/)